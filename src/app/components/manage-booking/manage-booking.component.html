@if(booking(); as booking) {
<div class="booking-portal">
  <!-- Header Section -->
  <header class="booking-header">
    <div class="header-content">
      <div class="welcome-section">
        <h1 class="welcome-title">
          Welcome back, {{ booking?.customer?.firstName }}!
        </h1>
        <p class="welcome-subtitle">Manage your rental reservation</p>
      </div>
      <div class="status-badge confirmed">
        <span class="status-text">Confirmed</span>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Vehicle Card -->
    <section class="vehicle-section">
      <div class="vehicle-card">
        <div class="vehicle-image-container">
          <img 
            class="vehicle-image" 
            [src]="booking.vehicle.photos[0].url" 
            [alt]="booking.vehicle.details?.year + ' ' + booking.vehicle.details?.make + ' ' + booking.vehicle.details?.model">
          <div class="vehicle-status-overlay">
            <div class="status-badge confirmed">
              <span>Confirmed</span>
            </div>
          </div>
          <div class="action-overlay">
            <button 
              class="verify-btn" 
              [disabled]="isLoadingVerification" 
              (click)="createVerificationSession(booking)">
              @if(isLoadingVerification) {
                <span>Verifying...</span>
              } @else {
                <span>Verify License</span>
              }
            </button>
          </div>
        </div>
        
        <div class="vehicle-info">
          <h2 class="vehicle-title">
            {{ booking.vehicle.details?.year }}
            {{ booking.vehicle.details?.make }}
            {{ booking.vehicle.details?.model }}
          </h2>
          <p class="vehicle-trim">{{ booking.vehicle.details?.trim }}</p>
          
          <div class="vehicle-specs-and-guide">
            <div class="vehicle-specs">
              <div class="spec-item">
                <mat-icon class="spec-icon">local_gas_station</mat-icon>
                <span class="spec-text">{{ booking.vehicle.details?.gasoline || 'Gasoline' }}</span>
              </div>
              <div class="spec-item">
                <mat-icon class="spec-icon">settings</mat-icon>
                <span class="spec-text">{{ booking.vehicle.details?.transmission || 'Automatic' }}</span>
              </div>
              <div class="spec-item">
                <mat-icon class="spec-icon">airline_seat_recline_normal</mat-icon>
                <span class="spec-text">{{ booking.vehicle.details?.seats || '5' }} Seats</span>
              </div>
            </div>
            
            <div class="vehicle-guide-buttons">
              @if(vehicleGuide.greeting) {
                <button class="guide-button greeting-btn" (click)="openGreetingDialog()">
                  <mat-icon>waving_hand</mat-icon>
                  <span>Welcome</span>
                </button>
              }
              
              @if(vehicleGuide.directions) {
                <button class="guide-button directions-btn" (click)="openDirectionsDialog()">
                  <mat-icon>directions_car</mat-icon>
                  <span>Instructions</span>
                </button>
              }
              
              @if(vehicleGuide.questions) {
                <button class="guide-button questions-btn" (click)="openQuestionsDialog()">
                  <mat-icon>help_outline</mat-icon>
                  <span>FAQ</span>
                </button>
              }
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Navigation Tabs -->
    <section class="tabs-section">
      <nav class="tab-navigation">
        <button 
          class="tab-button" 
          [class.active]="selectedTabIndex === 0"
          (click)="goToTab(0)">
          <span class="tab-text">Trip Details</span>
        </button>
        <button 
          class="tab-button" 
          [class.active]="selectedTabIndex === 1"
          (click)="goToTab(1)">
          <span class="tab-text">Messages</span>
        </button>
        <button 
          class="tab-button" 
          [class.active]="selectedTabIndex === 2"
          (click)="goToTab(2)">
          <span class="tab-text">Payment</span>
        </button>
      </nav>

      <!-- Tab Content -->
      <div class="tab-content-container">
        <!-- Trip Details Tab -->
        @if(selectedTabIndex === 0) {
          <div class="tab-content trip-details-content">
            <!-- Trip Timeline -->
            <div class="timeline-section">
              <h3 class="section-title">
                Your Trip Timeline
              </h3>
              
              <div class="timeline">
                <!-- Pickup -->
                <div class="timeline-item pickup">
                  <div class="timeline-marker">
                  </div>
                  <div class="timeline-content">
                    <div class="timeline-header">
                      <h4 class="timeline-title">Pickup</h4>
                      <div class="timeline-date">
                        <span class="date-day">{{ booking.reservation?.startDate ? (booking.reservation.startDate.toDate() | date : 'EEE') : '' }}</span>
                        <span class="date-main">{{ booking.reservation?.startDate ? (booking.reservation.startDate.toDate() | date : 'MMM d') : '' }}</span>
                        <span class="date-time">{{ booking.reservation?.startDate ? (booking.reservation.startDate.toDate() | date : 'h:mm a') : '' }}</span>
                      </div>
                    </div>
                    <div class="location-info">
                      <button 
                        type="button" 
                        class="location-link" 
                        (click)="openMapLocation(booking.reservation.pickupLocation.location.place.description)"
                        [attr.aria-label]="'Open ' + (booking.reservation.pickupLocation.location.place.description || 'pickup location') + ' in Google Maps'">
                        {{ booking.reservation.pickupLocation.location.place.description }}
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Journey Arrow -->
                <div class="timeline-connector">
                  <span class="connector-line"></span>
                </div>

                <!-- Return -->
                <div class="timeline-item return">
                  <div class="timeline-marker">
                  </div>
                  <div class="timeline-content">
                    <div class="timeline-header">
                      <h4 class="timeline-title">Return</h4>
                      <div class="timeline-date">
                        <span class="date-day">{{ booking.reservation?.endDate ? (booking.reservation.endDate.toDate() | date : 'EEE') : '' }}</span>
                        <span class="date-main">{{ booking.reservation?.endDate ? (booking.reservation.endDate.toDate() | date : 'MMM d') : '' }}</span>
                        <span class="date-time">{{ booking.reservation?.endDate ? (booking.reservation.endDate.toDate() | date : 'h:mm a') : '' }}</span>
                      </div>
                    </div>
                    <div class="location-info">
                      <button 
                        type="button" 
                        class="location-link" 
                        (click)="openMapLocation(booking.reservation.dropoffLocation.location.place.description)"
                        [attr.aria-label]="'Open ' + (booking.reservation.dropoffLocation.location.place.description || 'dropoff location') + ' in Google Maps'">
                        {{ booking.reservation.dropoffLocation.location.place.description }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Map Section -->
            <div class="map-section">
              <h3 class="section-title">
                Pickup Location
              </h3>
              <div class="map-container">
                <div class="map-placeholder">
                  <p>Interactive map will load here</p>
                </div>
              </div>
            </div>

            <!-- Host Contact -->
            <div class="host-section">
              <h3 class="section-title">
                Your Host
              </h3>
              <div class="host-card">
                <div class="host-info">
                  <div class="host-avatar">{{ booking?.fleet?.name?.[0] }}</div>
                  <div class="host-details">
                    <h4 class="host-name">{{ booking?.fleet?.name }}</h4>
                    <p class="host-description">Available to help with your trip</p>
                  </div>
                </div>
                <div class="host-actions">
                  <button 
                    type="button" 
                    class="contact-btn" 
                    (click)="callHost()"
                    aria-label="Call host">
                    <span class="btn-label">Call</span>
                  </button>
                  <button 
                    type="button" 
                    class="contact-btn" 
                    (click)="emailHost()"
                    aria-label="Email host">
                    <span class="btn-label">Email</span>
                  </button>
                  <button 
                    type="button" 
                    class="contact-btn" 
                    (click)="chatWithHost()"
                    aria-label="Chat with host">
                    <span class="btn-label">Chat</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        }

        <!-- Messages Tab -->
        @if(selectedTabIndex === 1) {
          <div class="tab-content messages-content">
            <div class="messages-header">
              <h3 class="section-title">
                Chat with {{ booking?.fleet?.name }}
              </h3>
              <div class="quick-contact">
                <button 
                  type="button" 
                  class="quick-contact-btn" 
                  (click)="callHost()"
                  aria-label="Call host">
                  <span class="btn-label">Call</span>
                </button>
                <button 
                  type="button" 
                  class="quick-contact-btn" 
                  (click)="emailHost()"
                  aria-label="Email host">
                  <span class="btn-label">Email</span>
                </button>
              </div>
            </div>
            
            <div class="conversation-container">
              <lib-conversation 
                #conversationCmp 
                [thread]="booking().bookingId" 
                [booking]="booking" 
                [fleet]="fleet()"
                [guest]="booking().customer" 
                [account]="booking().customer" 
                [styles]="'height:100%'">
              </lib-conversation>
            </div>
          </div>
        }

        <!-- Payment Tab -->
        @if(selectedTabIndex === 2) {
          <div class="tab-content payment-content">
            <!-- Pricing Section -->
            <div class="pricing-section">
              <h3 class="section-title">
                Pricing Breakdown
              </h3>
              <div class="pricing-notice">
                <p>Charges may be adjusted for tolls, parking tickets, or other expenses incurred during your reservation.</p>
              </div>
              <lib-pricing-breakdown [hideFees]="true" [booking]="booking"></lib-pricing-breakdown>
            </div>

            <!-- Payment Method Section -->
            <div class="payment-method-section">
              <h3 class="section-title">
                Payment Method
              </h3>
              <div class="payment-notice">
                <p>Add a secure payment method for any additional charges. Your information is encrypted and protected.</p>
              </div>
              <div class="payment-actions">
                <button class="add-payment-btn" (click)="openPaymentDialog()">
                  <span>Add Payment Method</span>
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    </section>
  </main>
</div>
} @else {
<div class="loading-container">
  <div class="loading-spinner"></div>
  <p class="loading-text">Loading your booking details...</p>
</div>
}

<!-- Payment Dialog -->
<dialog class="payment-dialog" #paymentDialog>
  <div class="dialog-header">
    <h3>Add Payment Method</h3>
    <button 
      type="button" 
      class="close-btn" 
      (click)="closePaymentDialog()"
      aria-label="Close dialog">
      Close
    </button>
  </div>
  <div class="dialog-content">
    <div id="payment-element"></div>
  </div>
  <div class="dialog-actions">
    <button class="dialog-btn secondary" (click)="closePaymentDialog()">Cancel</button>
    <button class="dialog-btn primary" (click)="submitHandler()">
      <span>Add Secure Payment</span>
    </button>
  </div>
</dialog>